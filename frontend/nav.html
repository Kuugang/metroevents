<nav id="nav" class="fixed shadow-2xl top-0 flex flex-row justify-between w-full p-3 bg-zinc-100 z-50">
    <a href="dashboard.php">Metro Events</a>
</nav>

<script type="module">
    import auth from "./checkAuth.js"
    import api from "./api/api.js"
    document.addEventListener("DOMContentLoaded", async function () {
        const authenticated = auth.checkAuthentication();
        const navUserLinks = document.getElementById("navUserLinks");

        if (api.parseJwt(document.cookie).isOrganizer) {
            document.getElementById("nav").innerHTML += `
                <a href="createEvent.php" id = "createEvent">Create Event</a>
            `;
        }

        if (authenticated) {
            let notifications = await api.getNotifications();
            notifications = notifications.reverse();
            notifications.sort((a, b) => {
                if (a.status === 1 && b.status !== 1) {
                    return 1;
                } else if (a.status !== 1 && b.status === 1) {
                    return -1;
                } else {
                    return 0;
                }
            });

            const unread_count = notifications.filter(notification => notification.status === 0);

            document.getElementById("nav").innerHTML += `
                <div id = "navUserLinks" class = "flex flex-row gap-2">
                    <div>
                        <a href="profile.php">
                            <i class="fa-regular fa-user fa-lg"></i>
                        </a>
                        <button id = "bellButton" class = "relative"}>
                            <i class="fa-regular fa-bell fa-lg"></i>
                            <p class = "font-semibold absolute -top-1 -right-1">
                                ${unread_count.length}
                            </p>
                        <button>
                        <div id = "notifications" class="dropdown-content hidden absolute bg-white border border-gray-300 right-0 p-1 mt-2 rounded-md shadow-md">

                        </div>
                    </div>
                    <button id = "logoutButton">Logout</button>
                </div>
            `

            notifications.forEach(notification => {
                const e =
                    `
                <div id = ${notification.event_id} class = "p-3 ${notification.status === 0 ? 'bg-gray-200' : ""} hover:bg-gray-100">
                    ${Boolean(notification.notification_type === 1 || notification.notification_type === 3) ?
                        `<button class = "notification-button" id = "${notification.id}">${notification.notification}</button>`
                        :
                        `<p>
                            ${notification.notification}
                        </p>`
                    }
                </div>
            `
                document.getElementById("notifications").innerHTML += e;
            });

            const bellButton = document.getElementById('bellButton');
            const dropdownContent = document.querySelector('.dropdown-content');
            const notification_buttons = document.querySelectorAll(".notification-button");

            bellButton.addEventListener('click', function () {
                dropdownContent.classList.remove('hidden');
            });

            document.addEventListener('click', function (event) {
                if (!bellButton.contains(event.target) && !dropdownContent.contains(event.target)) {
                    dropdownContent.classList.add('hidden');
                }
            
                // if (bellButton.contains(event.target) && (dropdownContent.classList.contains("hidden"))) {
                //     dropdownContent.classList.add('hidden');
                // }
            });

            notification_buttons.forEach(button => {
                button.addEventListener("click", async function(e){
                    await api.readNotification(e.target.id);
                    window.location.href = `/event.php?event_id=${e.target.parentElement.id}`;
                })
            })
            
        }

        const logoutButton = document.getElementById("logoutButton");
        if (logoutButton) {
            logoutButton.addEventListener("click", async function (e) {
                e.preventDefault();
                try {
                    const respose = await fetch("http://localhost:6969/user/logout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        credentials: "include",
                    });
                    if (respose.ok) {
                        document.cookie =
                            "auth=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
                        localStorage.removeItem("user");
                        window.location.href = "index.php";
                    }
                } catch (error) {
                    console.log(error);
                    alert(error);
                }
            });
        }
    })
</script>